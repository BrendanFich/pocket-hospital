<html>
    <head>
        <title>电子健康卡</title>
        <script type="text/javascript" src="https://js.aq.qq.com/js/aq_common.js"></script>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <link rel="stylesheet" type="text/css" href="css/base.css" />
        <link rel="stylesheet" type="text/css" href="css/weui.min.css" />
        <script type="text/javascript">
            // 在引入的css文件名后面加时间戳，防止浏览器读缓存
            document.write('<link rel="stylesheet" type="text/css" href="css/personal.css?timestamp='
                + new Date().getTime() + '" type="text/javascript" charset="utf-8"><\/script>')
        </script>
    </head>
    <body>
        <div class="wrap">
            <div class="qrcode-block">
                <div class="qrcode"></div>
                <p style="margin-top: .2rem; padding: 0;text-align: center;background-color: #fff;">挂号就诊时出示凭证</p>
            </div>
            <div class="text-block">
                <div class="text-element border">
                    <div class="label">姓名</div>
                    <div class="value" id="name"></div>
                </div>
                <div class="text-element border">
                    <div class="label">身份证号</div>
                    <div class="value" id="idcard"></div>
                </div>
                <div class="text-element">
                    <div class="label">手机号</div>
                    <div class="value" id="phone"></div>
                </div>
            </div>
            <div class="operation">
                <a class="button" id="setDefault">设为默认卡</a>
                <a class="button" id="entercard">进入卡包</a>
                <a class="link" id="openpopwindow">解绑电子健康卡 ></a>
            </div>
        </div>
        <div class="mask" style="display: none">
            <div id="popwindow" class="popwindow">
                <div class="text">
                    <h5>操作确认</h5>
                    <p>确认要解除当前就诊人与当前微信账号的绑定关系吗？</p>
                </div>
                <div class="operation">
                    <a class="unbind" id="unbing-btn">解绑</a>
                    <div class="line"></div>
                    <a class="cancel" id="cancel-btn">取消</a>
                </div>
            </div>
        </div>
    </body>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.qrcode.js"></script>
    <script type="text/javascript" src="js/jquery-barcode.min.js"></script>
    <script type="text/javascript" src="js/qrcode.js"></script>
    <script type="text/javascript" src="js/utf.js"></script>
    <script type="text/javascript" src="js/weui.min.js"></script>
    <script>
    (function() {
        var cardTypeObj = {
            '10': '就诊卡',
            '11': '健康卡',
            '99': '其他法定有效证件',
            '01': '身份证号',
            '02': '居民户口簿',
            '03': '护照',
            '04': '军官证',
            '05': '驾驶证',
            '06': '港澳居民来往内地通行证',
            '07': '台湾居民来往内地通行证',
            '08': '出生医学证明',
            '09': '医保卡'
        };
        init(cardTypeObj);
        $('#openpopwindow').click(function() {
            $('.mask').show();
        });
        $('#cancel-btn').click(function() {
            $('.mask').hide();
        });
        $('#unbing-btn').click(function() {
            $.ajax({
                url: 'https://healthcarddemo.tengmed.com/index.php?c=healthcard&a=unbind',
                data: {
                    qrCodeText: getQueryString('qrCodeText')
                },
                dataType: 'json',
                type: 'post',
                success: function(res) {
                    if (res.retcode === 0) {
                        window.location.href = 'list.html';
                    } else {
                        weui.toast(res.retmsg)
                    }
                }
            });
        });
        $('#setDefault').click(function() {
            $.ajax({
                url: 'https://healthcarddemo.tengmed.com/index.php?c=healthcard&a=getOrderIdByOutAppId',
                data: {
                    patCardNo: getQueryString('qrCodeText'),
                    patName: getQueryString('name')
                },
                dataType: 'json',
                type: 'post',
                success: function(res) {
                    if (res.code === 0) {
                        weui.toast('切换成功')
                    }
                }
            });
        })
        $('#entercard').click(function() {
            $.ajax({
                url: 'https://healthcarddemo.tengmed.com/index.php?c=healthcard&a=getOrderIdByOutAppId',
                data: {
                    qrCodeText: getQueryString('qrCodeText')
                },
                dataType: 'json',
                type: 'post',
                success: function(res) {
                    if (res.retcode === 0) {
                        window.location.href =
                            'https://health.tengmed.com/open/takeMsCard?order_id=' +
                            res.orderId +
                            '&redirect_uri=' +
                            encodeURIComponent('https://healthcarddemo.tengmed.com/healthcard/list.html');
                    }
                }
            });
        });
    })();

    function init(cardTypeObj) {
        var name = getQueryString('name') || '';
        var idCard = getQueryString('idCard') || '*****';
        var qrCodeText = getQueryString('qrCodeText') || '';
        var phone = getQueryString('phone') || '';
        var cardType = getQueryString('cardType') || 1;
        var verify = getQueryString('verify') || false;
        cardType = parseInt(cardType) > 9 ? cardType.toString() : '0' + cardType;

        // if (cardType !== '01') {
        //     $('.idcard-link').css('display', 'block');
        //     $('#idcard').css('display', 'none');
        // }

        $('#name').html(name);
        $('#idcard').html(idCard);
        $('#phone').html(phone);
        $('#idcard')
            .prev()
            .html(cardTypeObj['01']);
        jQuery('.qrcode').qrcode({
            width: '200', //二维码的宽度
            height: '200',
            render: 'canvas',
            text: qrCodeText,
            background: '#ffffff', //二维码的后景色
            foreground: '#000000', //二维码的前景色
            src: 'img/logo_.png' //二维码中间的图片
        });

        if (verify) {
            weui.toast('实名认证成功', {
                duration: 2000,
                className: 'verify-toast'
            });
        }
    }

    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)'); // 匹配目标参数
        var result = window.location.search.substr(1).match(reg); // 对querystring匹配目标参数
        if (result != null) {
            return decodeURIComponent(result[2]);
        } else {
            return null;
        }
    }

    </script>
</html>
